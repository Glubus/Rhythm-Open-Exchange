name: Publish

on:
  push:
    branches: [main]
    paths:
      - Cargo.toml
      - bindings/ffi/Cargo.toml

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - run: cargo test --all

  publish-crates:
    name: Publish to crates.io
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Publish library
        run: cargo publish --token ${{ secrets.CARGO_TOKEN }}

  # --- PYTHON (PyPI) ---
  publish-pypi:
    name: Publish to PyPI
    needs: test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - uses: actions-rust-lang/setup-rust-toolchain@v1

      # Prerequisite: Generate the Python wrapper source code
      - name: Generate Python Sources
        shell: bash
        run: |
          cargo run -p rox-ffi --features uniffi/cli --bin uniffi-bindgen -- generate --library target/debug/librox_ffi.so --language python --out-dir bindings/ffi/python --no-format
        # Note: We rely on cargo run to build the debug lib first if needed, or maturin handles it?
        # Actually Maturin builds the extension. But we need the python *file* generated by uniffi-bindgen.
        # To run bindgen, we need a compiled library (even debug).

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          working-directory: bindings/ffi
          args: --release --out dist

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: bindings/ffi/dist

  upload-pypi:
    name: Upload to PyPI
    needs: publish-pypi
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}
          packages-dir: dist

  # --- C# (NuGet) ---
  build-native-libs:
    name: Build Native Libs for NuGet
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: linux-x64
            lib_name: librox_ffi.so
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: win-x64
            lib_name: rox_ffi.dll
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: osx-arm64
            lib_name: librox_ffi.dylib
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.target }}

      - name: Build Release
        run: cargo build --release -p rox-ffi --target ${{ matrix.target }}

      - name: Upload Native Lib
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.artifact_name }}
          path: target/${{ matrix.target }}/release/${{ matrix.lib_name }}

  publish-nuget:
    name: Publish to NuGet
    needs: build-native-libs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1 # For running uniffi-bindgen

      # 1. Download Native Libs
      - uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: native_libs

      # 2. Organize libs for NuGet content
      - name: Organize Native Libs
        run: |
          mkdir -p bindings/ffi/csharp/runtimes/linux-x64/native
          mkdir -p bindings/ffi/csharp/runtimes/win-x64/native
          mkdir -p bindings/ffi/csharp/runtimes/osx-arm64/native

          cp native_libs/native-linux-x64/librox_ffi.so bindings/ffi/csharp/runtimes/linux-x64/native/
          cp native_libs/native-win-x64/rox_ffi.dll bindings/ffi/csharp/runtimes/win-x64/native/
          cp native_libs/native-osx-arm64/librox_ffi.dylib bindings/ffi/csharp/runtimes/osx-arm64/native/

      # 3. Generate C# Binding Source (Needs a compiled lib to run the bindgen, let's use linux lib we just got)
      - name: Generate C# Source
        run: |
          # Use the Linux .so to generate bindings (API is same)
          cargo run -p rox-ffi --bin uniffi-bindgen-cs -- --library --out-dir bindings/ffi/csharp bindings/ffi/csharp/runtimes/linux-x64/native/librox_ffi.so

      # 4. Pack & Push
      - name: Pack NuGet
        run: dotnet pack bindings/ffi/csharp/Rox.csproj -c Release -o out

      - name: Push to NuGet
        run: dotnet nuget push "out/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json

  # Create GitHub Release
  release:
    name: Create GitHub Release
    needs: [publish-crates, upload-pypi, publish-nuget]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Get version
        id: version
        run: echo "version=$(grep '^version' Cargo.toml | head -1 | cut -d'"' -f2)" >> $GITHUB_OUTPUT
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          generate_release_notes: true
